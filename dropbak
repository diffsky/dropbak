#!/bin/bash
usage()
{
cat << EOF

rsync files to a (dropbox) location, filtering on .gitignore and .dbignore files

USAGE:

dropbak <source> <destination> [interval]

OPTIONS:
    -h      show usage info
    -i      interval time to run [seconds]
    -d      delay initial run by [seconds]

EOF
exit 1
}

if [ -z "$2" ];then
  usage
fi

OPTIND=3
while getopts "hi:d:" option
do
  case $option in
    h) usage;;
    i) INTERVAL=$OPTARG;;
    d) DELAY=$OPTARG;;
    \?) usage;exit 2;;
  esac
done

if [ ! -z "$DELAY" ];then
  SLEEP "$DELAY"
fi

if [ -z "$INTERVAL" ];then
  INTERVAL=300
fi

if [ -f "$HOME/.dbignore" ];then
  HOME_DBIGNORE="--filter=.- $HOME/.dbignore"
fi

if [ -f "$HOME/.gitignore" ];then
  HOME_GITIGNORE="--filter=.- $HOME/.gitignore"
fi

while true; do
  T="$(date +%s)"
  rsync -ra --delete --stats --human-readable --filter=':- .dbignore' "$HOME_DBIGNORE" --filter=':- .gitignore' "$HOME_GITIGNORE" "$1" "$2"
  T="$(($(date +%s)-T))"
  let D=INTERVAL-T
  if [ $D -gt 0 ]; then
    sleep $D
  fi
done
